-- AutoExec Volcano Safe Loader + Respawn UI Detection
task.defer(function()
    repeat task.wait() until game:IsLoaded()

    local Players = game:GetService("Players")
    local TweenService = game:GetService("TweenService")
    local TeleportService = game:GetService("TeleportService")
    local ReplicatedStorage = game:GetService("ReplicatedStorage")

    repeat task.wait() until Players.LocalPlayer
    local LocalPlayer = Players.LocalPlayer
    local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

    -- CONFIG
    local FORCE_MODE = "REJOIN" -- "RESPAWN" / "REJOIN"
    local AUTO_RESPAWN_UI = true -- auto klik tombol respawn UI
    local TELEPORT_STYLE = "instant"
    local DEFAULT_DELAY = 1.5
    local HEIGHT_OFFSET = 5
    local RESPAWN_DELAY = 3
    local START_DELAY = 5
    local STUCK_TIMEOUT = 15
    local FORCE_DELAY_LOAD = 5
    local runCounter = 0

    -- Data checkpoint
    local checkpoints = {
        {name="CP 1",pos={y=-59.0025,x=-1537.7333,z=424.2811}, delay=1.5, style="instant"},
        {name="CP 2",pos={y=25.6676,x=-739.8878,z=172.8593}, delay=1.5, style="instant"},
        {name="CP 3",pos={y=222.8750,x=-423.4078,z=90.9274}, delay=1.5, style="instant"},
        {name="CP 4",pos={y=293.7064,x=-302.4740,z=130.5271}, delay=1.5, style="instant"},
        {name="CP 5",pos={y=164.7641,x=390.9039,z=-27.3549}, delay=1.5, style="instant"},
        {name="CP 6",pos={y=-61.9863,x=163.1314,z=-624.9088}, delay=1.5, style="instant"},
        {name="CP 7",pos={y=-64.3647,x=867.7789,z=201.3180}, delay=1.5, style="instant"},
        {name="CP 8",pos={y=-35.0197,x=1069.9063,z=815.7617}, delay=1.5, style="instant"},
        {name="CP 9",pos={y=-1.3588,x=1321.3037,z=1399.4094}, delay=1.5, style="instant"},
        {name="CP 10",pos={y=45.7678,x=1264.6719,z=1520.8422}, delay=1.5, style="instant"},
        {name="CP 11",pos={y=132.8174,x=1235.6938,z=1570.7618}, delay=1.5, style="instant"},
        {name="CP 12",pos={y=232.3537,x=1133.4136,z=1576.9730}, delay=1.5, style="instant"},
        {name="CP 13",pos={y=315.0438,x=1260.7890,z=1618.4626}, delay=1.5, style="instant"},
        {name="CP 14",pos={y=332.1848,x=989.3219,z=1669.4172}, delay=1.5, style="instant"},
        {name="CP 15",pos={y=357.0771,x=1152.2606,z=1562.4810}, delay=1.5, style="instant"},
        {name="CP 16",pos={y=365.8235,x=1107.8200,z=1592.0671}, delay=1.5, style="instant"},
        {name="CP 17",pos={y=464.8759,x=1119.3842,z=1607.0626}, delay=2, style="tween"},
    }

    -- Utils
    local function waitForCharacter()
        while not LocalPlayer.Character
            or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
            or not LocalPlayer.Character:FindFirstChild("Humanoid") do
            LocalPlayer.CharacterAdded:Wait()
            task.wait(0.3)
        end
        return LocalPlayer.Character
    end

    local function teleportTo(pos, style)
        local char = waitForCharacter()
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if not hrp then return end
        local target = Vector3.new(pos.x, pos.y + HEIGHT_OFFSET, pos.z)
        if style == "tween" then
            local tween = TweenService:Create(hrp, TweenInfo.new(1, Enum.EasingStyle.Linear), {CFrame = CFrame.new(target)})
            tween:Play()
            tween.Completed:Wait()
        else
            hrp.CFrame = CFrame.new(target)
        end
    end

    local function isOnGround()
        local char = LocalPlayer.Character
        if not char then return false end
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if not hrp then return false end
        local ray = Ray.new(hrp.Position, Vector3.new(0,-10,0))
        local part, pos = workspace:FindPartOnRay(ray, char)
        return part ~= nil and (hrp.Position.Y - pos.Y) < (HEIGHT_OFFSET + 1)
    end

    local function waitUntilGroundOrTimeout()
        local start = tick()
        while true do
            if isOnGround() then return true end
            if tick() - start > STUCK_TIMEOUT then return false end
            task.wait(0.3)
        end
    end

    -- üî• Auto-detect UI Respawn
    if AUTO_RESPAWN_UI then
        PlayerGui.ChildAdded:Connect(function(child)
            if child:IsA("ScreenGui") and child:FindFirstChildWhichIsA("TextButton", true) then
                local button = child:FindFirstChildWhichIsA("TextButton", true)
                if button and button.Text:lower():find("respawn") then
                    print("[AutoSummit] üü¢ Detected Respawn UI ‚Üí Auto click")
                    task.wait(1)
                    pcall(function() firesignal(button.MouseButton1Click) end)
                end
            end
        end)
    end

    local function doRespawn()
        local remote = ReplicatedStorage:FindFirstChild("RespawnPlayer")

        print("[AutoSummit] üíÄ Trigger respawn...")
        local char = waitForCharacter()
        local hum = char:FindFirstChild("Humanoid")
        if hum then hum.Health = 0 end

        task.wait(1.5)
        if remote then
            print("[AutoSummit] üîÅ Respawn via RemoteEvent")
            remote:FireServer()
        end

        task.wait(RESPAWN_DELAY)
    end

    local function autoSummit()
        while true do
            for _, cp in ipairs(checkpoints) do
                local success = false
                local tries = 0
                while not success and tries < 3 do
                    tries += 1
                    teleportTo(cp.pos, cp.style or TELEPORT_STYLE)
                    success = waitUntilGroundOrTimeout()
                    if not success then
                        warn("[AutoSummit] ‚ùå Stuck di " .. cp.name .. " ‚Üí retry " .. tries)
                        task.wait(1)
                    else
                        print("[AutoSummit] ‚úÖ " .. cp.name)
                    end
                end
                task.wait(cp.delay or DEFAULT_DELAY)
            end

            runCounter += 1
            print("[AutoSummit] üéâ Run ke-" .. runCounter .. " selesai!")

            if FORCE_MODE == "REJOIN" then
                print("[AutoSummit] üîÑ Rejoin server...")
                TeleportService:Teleport(game.PlaceId, LocalPlayer)
                return
            else
                doRespawn()
            end
        end
    end

    -- Main Loop
    while true do
        local ok, err = pcall(function()
            waitForCharacter()
            print("[AutoSummit] ‚è≥ Loading delay " .. FORCE_DELAY_LOAD .. "s...")
            task.wait(FORCE_DELAY_LOAD)
            task.wait(START_DELAY)
            autoSummit()
        end)
        if not ok then
            warn("[AutoSummit] ‚ö†Ô∏è Error:", err)
            task.wait(5)
        end
    end
end)
